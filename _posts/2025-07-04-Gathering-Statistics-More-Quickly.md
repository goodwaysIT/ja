---
layout: post
title: "統計情報をより迅速に収集する"
excerpt: "本論文では、Oracleデータベースで最も一般的なシナリオにおいて、いつ・どのように統計情報を収集すべきか詳細に議論します。"
date: 2025-07-04 11:00:00 +0800
categories: [Oracle, Database]
tags: [Database maintenance, Database deployment,Database optimization, oracle]
image: /assets/images/posts/Gathering-Statistics-More-Quickly.jpg
---

## 統計情報をより迅速に収集する  
データ量が増加しメンテナンス期間が短縮される中、統計情報をタイムリーに収集することはこれまで以上に重要です。Oracleでは、統計収集操作の並列化から統計の収集ではなく生成まで、統計収集を高速化する様々な方法を提供しています。  

**並列処理の活用**  
統計収集ではいくつかの方法で並列処理を活用できます  
» DEGREEパラメータの使用  
» 同時統計情報収集  
» DEGREEと同時収集の組み合わせ  

**DEGREEパラメータの使用**  
DBMS_STATSのDEGREEパラメータは、統計収集に使用される並列実行プロセスの数を制御します。  
デフォルトでは、Oracleはデータディクショナリ内のテーブル属性として指定された並列サーバープロセス数（並列度）と同じ数を使用します。Oracleデータベース内のすべてのテーブルは、デフォルトでこの属性が1に設定されています。大規模なテーブルの統計収集を高速化するために、このパラメータを明示的に設定すると有用です。  

代わりに、DEGREEをAUTO_DEGREEに設定できます。Oracleはオブジェクトのサイズに基づいて、統計収集に使用すべき適切な並列サーバープロセス数を自動的に決定します。この値は、小規模オブジェクトの場合は1（直列実行）から、大規模オブジェクトの場合はDEFAULT_DEGREE（PARALLEL_THREADS_PER_CPU X CPU_COUNT）の間になります。  

パーティション表に対してDEGREEを設定すると、複数の並列サーバープロセスが各パーティションの統計収集に使用されますが、異なるパーティションで統計が同時に収集されるわけではないことに注意してください。統計は各パーティションで順次収集されます。  

**同時統計情報収集**  
同時統計情報収集により、スキーマ（またはデータベース）内の複数のテーブル、およびテーブル内の複数の（サブ）パーティションで同時に統計を収集できます。複数のテーブルと（サブ）パーティションで同時に統計を収集することで、Oracleがマルチプロセッサ環境を完全に活用できるようになり、統計収集全体の時間を短縮できます。  

同時統計情報収集はグローバルプリファレンスCONCURRENTによって制御され、MANUAL、AUTOMATIC、ALL、OFFに設定できます。デフォルトはOFFです。CONCURRENTが有効な場合、OracleはOracleジョブスケジューラとAdvanced Queuingコンポーネントを使用して、複数の統計収集ジョブを同時に作成および管理します。  

CONCURRENTがMANUALまたはALLに設定されている状態で、パーティション表に対してDBMS_STATS.GATHER_TABLE_STATSを呼び出すと、Oracleはテーブル内の各（サブ）パーティションに対して個別の統計収集ジョブを作成します。これらのジョブのうち、同時に実行される数とキューイングされる数は、利用可能なジョブキュープロセス数（JOB_QUEUE_PROCESSES初期化パラメータ、RAC環境ではノードごと）および利用可能なシステムリソースに基づきます。現在実行中のジョブが完了すると、さらにジョブがデキューされて実行され、すべての（サブ）パーティションの統計が収集されるまで続きます。  

DBMS_STATS.GATHER_DATABASE_STATS、DBMS_STATS.GATHER_SCHEMA_STATS、またはDBMS_STATS.GATHER_DICTIONARY_STATSを使用して統計を収集する場合、Oracleは以下の処理を行います：  
非パーティション表ごと、およびパーティション表の各（サブ）パーティションごとに個別の統計収集ジョブを作成します。各パーティション表には、その（サブ）パーティションジョブを管理するコーディネータージョブも存在します。データベースは可能な限り多くの同時ジョブを実行し、実行中のジョブが完了するまで残りのジョブをキューイングします。  

ただし、デッドロックの可能性を防ぐため、複数のパーティション表を同時に処理することはできません。  
したがって、パーティション表のジョブが実行中の場合、スキーマ（またはデータベース、ディクショナリ）内の他のパーティション表は、現在の処理が完了するまでキューイングされます。非パーティション表にはこのような制限はありません。  

個々の統計収集ジョブも、DEGREEパラメータが指定されていれば並列実行を活用できます。  

テーブル、パーティション、またはサブパーティションが非常に小さいか空の場合、データベースはそのオブジェクトを他の小規模オブジェクトと自動的に1つのジョブにまとめ、ジョブ管理のオーバーヘッドを削減することがあります。  

**同時統計情報収集の設定**  
統計収集の同時実行設定はデフォルトで無効です。以下のように有効にできます：  
```sql
exec dbms_stats.set_global_prefs('concurrent', 'all')
```
通常の統計収集に必要な権限に加えて、いくつかの追加権限も必要です。  
ユーザーは以下のジョブスケジューラおよびAQ権限を持っている必要があります：  
» CREATE JOB  
» MANAGE SCHEDULER  
» MANAGE ANY QUEUE  

SYSAUX表領域はオンラインである必要があります。ジョブスケジューラは内部テーブルとビューをSYSAUX表領域に格納するためです。最後に、JOB_QUEUE_PROCESSESパラメータは、統計収集プロセスに利用可能（または割り当て済み）なすべてのシステムリソースを完全に活用するように設定する必要があります。並列実行を使用しない予定の場合、JOB_QUEUE_PROCESSESをCPUコア総数の2倍に設定すべきです（これはRAC環境ではノードごとのパラメータです）。このパラメータはセッションレベル（ALTER SESSION）ではなく、システム全体で設定するようにしてください（ALTER SYSTEM ... またはinit.oraファイル内）。  

同時統計情報収集の一部として並列実行を使用する場合は、パラレル適応型マルチユーザーを無効にする必要があります：  

```sql
ALTER SYSTEM SET parallel_adaptive_multi_user=false;
```
リソースマネージャーは、例えば以下のようにして有効化する必要があります：

```sql
ALTER SYSTEM SET resource_manager_plan = 'DEFAULT_PLAN';
```
また、並列ステートメントキューイングを有効にすることをお勧めします。これにはリソースマネージャーの有効化と、コンシューマーグループ「OTHER_GROUPS」でキューイングが有効化された一時リソースプランの作成が必要です。デフォルトでは、リソースマネージャーはメンテナンス期間中のみ有効化されます。以下のスクリプトは、一時リソースプラン（pqq_test）を作成し、このプランでリソースマネージャーを有効にする方法を示しています。  

```sql
-- DBA権限を持つユーザーとして接続
begin
dbms_resource_manager.create_pending_area();
dbms_resource_manager.create_plan('pqq_test', 'pqq_test');
dbms_resource_manager.create_plan_directive(
'pqq_test',
'OTHER_GROUPS',
'pqq用OTHER_GROUPSディレクティブ',
parallel_target_percentage => 90);
dbms_resource_manager.submit_pending_area();
end;
/
ALTER SYSTEM SET RESOURCE_MANAGER_PLAN = 'pqq_test' SID='*';
```
自動化された統計収集タスクに同時実行を活用させたい場合は、CONCURRENTをAUTOMATICまたはALLに設定してください。新しいORA$AUTOTASKコンシューマーグループが、メンテナンスウィンドウ中に使用されるリソースマネージャープランに追加され、同時統計情報収集がシステムリソースを使いすぎないように保証されます  
