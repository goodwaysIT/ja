---
layout: post
title: "Replicatを安易にABENDさせない：REPERRORで実現するきめ細やかなエラーハンドリング"
excerpt: "Replicatが頻繁にABENDする悪夢に終止符を。本記事ではOGGのREPERRORパラメータを深く解説し、「全か無か」のジレンマから脱却する方法を伝授します。DISCARDやTRANSACTIONオプションを駆使して、弾力的で監査可能なエラーハンドリング戦略を構築し、システムの高可用性とデータ一貫性の完璧なバランスを実現しましょう。"
date: 2025-07-28 18:02:00 +0800
categories: [Oracle GoldenGate, Error Handling]
tags: [ogg, replicat, reperror, error handling, discard, abend, オラクルゴールデンゲート, エラーハンドリング, クロスプラットフォーム移行, エンディアン]
author: Shane
image: /assets/images/posts/ogg-reperror-banner.svg
---

データ同期プロセス中に、OGG Replicatプロセスは様々なデータベースエラー（例えばORA-00001一意性制約違反など）により異常終了（ABEND）することがよくあります。これはデータ同期を中断させ、遅延の蓄積を招くだけでなく、ビジネスの継続性にも影響を与える可能性があります。この時、あなたの頭に浮かぶ選択肢は2つしかないだろう。ターゲット側の競合データを手動で処理してプロセスを再起動するか、あるいはパラメータファイルに`REPERROR (DEFAULT, IGNORE)`と追記して「見て見ぬふり」をし、重要なデータが失われないことを祈るか。

これこそ、無数のOGG運用エンジニアが直面してきた「全か無か」のジレンマだ。私たちは「システムが利用不可」か「データが信頼できない」という、2つの悪魔の間で選択を迫られているように見える。

だが、現実はそうではない。今日、私はOGGエラーハンドリングにおける「第三の道」、つまり、受動的な火消し役の消防士から、能動的なガバナンスの設計者へとあなたを変えるスイスアーミーナイフ——`REPERROR`パラメータを紹介する。この記事を読めば、あなたのReplicatが「小さな問題」には柔軟に対応し、「大きな問題」には迅速に警告を発する、弾力的で監査可能なエラーハンドリングシステムを構築する方法がわかるだろう。

### 1. 困難の根源：デフォルト動作の「脆弱性」

まず理解すべきは、Replicatのデフォルト動作が実は「安全第一」の設計であるということだ。Replicatは非常に「正直」で、自身が解決できない問題に遭遇すると、まず停止（ABEND）し、問題を報告する。この設計の意図は良い。予期せぬデータの問題が静かに隠蔽されることを防ぐからだ。

しかし、複雑な本番環境では、多くのエラーは予期可能であり、時には「良性」でさえある。例えば：
*   **ORA-00001 (一意性制約違反)**: ターゲット側でデータのアーカイブやクリーンアップを行った際に、一部のデータを誤って削除した後、再度挿入された場合に発生する可能性がある。
*   **ORA-01403 (データが見つかりません)**: 双方向同期において、A側であるレコードが削除され、その削除操作がB側に同期されたとする。しかし、同時にB側でも手動で同じレコードが削除された場合、A側からの削除操作がB側に到達したとき、削除対象のデータが見つからずにORA-01403が発生する。

これらのエラーに対して、同期リンク全体を中断させるのは、明らかに「大げさ」であり、割に合わない。

**エラーハンドリングフローの概念図**
![Replicat Error Handling Flow]({{ '/assets/images/ogg/ogg-reperror-error-handling-flow.svg' | relative_url }})

### 2. `REPERROR`：「一括処理」から「精密射撃」へ

`REPERROR`パラメータの強力さは、**具体的なエラーコード**に基づいて、**具体的な処理動作**を定義できる点にある。その主要な使い方を見ていこう。

#### `IGNORE` vs `DISCARD`：履歴を残すか否か？

これは`REPERROR`の最も基本的で重要な2つのオプションだ。

*   **`IGNORE`（無視）**: 最も「乱暴な」処理方法だ。Replicatに「このエラーに遭遇したら、見なかったことにして、この操作をスキップし、次に進め」と指示する。
    *   **利点**: シンプルで直接的。
    *   **致命的な欠点**: **データが音もなく失われる**。どの操作が無視されたかを追跡するログや記録が一切残らない。これはデータ照合の悪夢の始まりであり、**本番環境での`IGNORE`の使用は強く避けるべきだ**と私は勧める。

*   **`DISCARD`（破棄）**: 私が推奨する「ゴールドスタンダード」だ。Replicatに「このエラーに遭遇したら、同様にこの操作をスキップするが、エラー詳細、SQL文、トランザクション情報など、この操作の完全な情報を、**破棄ファイル（Discard File）**にそのまま記録しておいてくれ」と指示する。
    *   **利点**: プロセスの継続的な実行を保証しつつ、**完全な監査証跡**を提供する。この破棄ファイルを定期的に確認し、破棄された操作を分析し、手動で修復することで、データの最終的な一貫性を確保できる。

#### 破棄ファイルの設定

`DISCARD`を使用するには、まずReplicatのパラメータファイルで破棄ファイルの場所とルールを定義する必要がある。

```ini
-- Replicatパラメータファイル (rep_main.prm)
REPLICAT rep_main
USERIDALIAS ogg_tgt_alias DOMAIN OracleGoldenGate

-- 破棄ファイルを定義。ファイル名は自動的にプロセス名とシーケンス番号が付加される
-- PURGEONDAYS 7 は7日分の破棄ファイルを保持し、その後自動的にクリーンアップ
-- MEGABYTES 100 は各破棄ファイルの最大サイズを100MBに設定
DISCARDFILE ./dirrpt/rep_main.dsc, APPEND, PURGEONDAYS 7, MEGABYTES 100

-- これが我々のエラーハンドリング戦略
-- ORA-00001エラーに遭遇した場合、DISCARD操作を実行する
REPERROR (ORA-00001, DISCARD)

-- MAP文
MAP sales.*, TARGET sales.*;
```
設定が完了すると、Replicatが`ORA-00001`エラーに遭遇してもABENDせず、代わりに`./dirrpt/`ディレクトリに以下のような内容の`.dsc`ファイルが生成される。
```
Oracle GoldenGate Delivery for Oracle process started, group REP_MAIN...
...
2023-10-27 16:30:15  WARNING OGG-01154  Oracle GoldenGate Delivery for Oracle, rep_main.prm:  SQL error 1 mapping SALES.ORDERS to SALES.ORDERS.
OCI Error ORA-00001: unique constraint (SALES.PK_ORDERS) violated
...
-- ここにエラーを引き起こした完全なSQL文がリストされる
INSERT INTO "SALES"."ORDERS" ("ORDER_ID", "CUSTOMER_ID", "ORDER_DATE", "AMOUNT")
VALUES (1001, 205, TO_DATE('2023-10-27 16:30:00', 'YYYY-MM-DD HH24:MI:SS'), 599.99);
```
このファイルがあれば、問題を追跡し修復するためのすべての証拠が手に入る。

### 3. スマートな「階層的エラー戦略」の構築

`REPERROR`の真の威力は、経験豊富な医師が処方箋を書くように、多層的で精緻なエラーハンドリング戦略を定義できることにある。

*   **「軽微な問題」（予期可能な良性エラー）に対しては、記録して処理を継続する。**
*   **「中程度の問題」（データ不整合の可能性を示唆）に対しては、現在のトランザクションを中止するが、プロセスは終了させない。**
*   **「重大な疾患」（未知または深刻なエラー）に対しては、直ちにプロセスをABENDさせ、人為的な注意を促す。**

`REPERROR`ルールを重ねることで、これを実現できる。Replicatは上から順にルールを照合し、一致するものが見つかれば対応するアクションを実行する。

**本番環境レベルの`REPERROR`設定例：**
```ini
-- Replicatパラメータファイル (rep_prod.prm)
REPLICAT rep_prod
USERIDALIAS ogg_tgt_alias DOMAIN OracleGoldenGate
DISCARDFILE ./dirrpt/rep_prod.dsc, APPEND, PURGEONDAYS 14, MEGABYTES 200

-- === きめ細やかなエラーハンドリング戦略 ===

-- 1. 一意性キー制約違反（ORA-00001）に対しては、破棄ファイルに記録して継続
REPERROR (ORA-00001, DISCARD)

-- 2. 「更新/削除対象行が見つからない」（ORA-01403）は、データ不整合の可能性を示唆する。
--    ここではTRANSACTIONレベルの処理を選択：現在のトランザクションの全操作を破棄し、
--    トランザクション全体を破棄ファイルに書き出し、次のトランザクションから処理を開始する。
--    これはABENDよりもエレガントだ。サービス全体を中断させないからだ。
REPERROR (ORA-01403, TRANSACTION)

-- 3. 明示的に指定されていない他のすべてのデータベースエラー（DEFAULT）に対しては、
--    プロセスを直ちにABENDさせ、DBAの注意を引く。未知の問題が隠蔽されるのを防ぐ。
--    これが最後の安全策だ。
REPERROR (DEFAULT, ABEND)

MAP fin.*, TARGET fin.*;
```
この設定は、階層的な処理思想を体現している。
*   **`DISCARD`**: 操作レベル（Operation-level）の処理。単一のDMLにのみ影響。
*   **`TRANSACTION`**: トランザクションレベル（Transaction-level）の処理。現在のトランザクションの全DMLに影響。
*   **`ABEND`**: プロセスレベル（Process-level）の处理。サービス全体を中断。

### まとめ：「火消し」から「防火」へ

`REPERROR`を巧みに活用することで、私たちはReplicatのエラーとの関わり方を根本的に変えることができる。

| 処理方法 | 利点 | 欠点 | 適用シーン |
| :--- | :--- | :--- | :--- |
| **デフォルト (ABEND)** | 安全、問題が見過ごされない | システム可用性が低い、頻繁な手動介入が必要 | 致命的、未知のエラー |
| **`IGNORE`** | プロセスが中断しない | **データブラックホール、監査不可** | **本番での使用は強く非推奨** |
| **`DISCARD`** | プロセスが中断せず、**完全な監査が可能** | 破棄ファイルの定期的な確認が必要 | 予期可能で許容範囲内の単発エラー |
| **`TRANSACTION`**| 問題のあるトランザクションを隔離、プロセスは中断しない | トランザクション全体のデータが破棄される | 論理的な問題が疑われるエラー |

次回、あなたのReplicatがよくあるエラーで停止したとき、条件反射的に`SKIPTRANSACTION`したり、乱暴に`IGNORE`したりするのをやめよう。心を落ち着けて、そのエラーの性質を考え、それに合った`REPERROR`ルールを仕立ててあげよう。

これは単に技術的な問題を解決するだけではない。受動的な「消防士」から、能動的な「防火システムの設計者」へと成長する、あなた自身のデータ専門家としての思考の転換なのだ。 